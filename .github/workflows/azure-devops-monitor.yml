name: Thallium ADO Card Movement Monitor

on:
  schedule:
    - cron: '0 11 * * 1-5'  # Weekdays only (Mon-Fri) at 11:00 AM UTC
  workflow_dispatch:
    inputs:
      target_column:
        description: "Target column to monitor (optional override)"
        required: false
        type: string
        default: "Testing"
      azure_devops_team:
        description: "Azure DevOps team/board to monitor (optional override)"
        required: false
        type: string
        default: "Reuters-Engineering\\Thallium"

run-name: Thallium ADO Card Movement Monitor - ${{ github.run_id }}

env:
  # Azure DevOps Configuration
  IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_ORG: ${{ secrets.IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_ORG }}
  IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_PROJECT: ${{ secrets.IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_PROJECT }}
  IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_TEAM: ${{ github.event.inputs.azure_devops_team || secrets.IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_TEAM }}
  IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_PAT: ${{ secrets.IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_PAT }}
  
  # GitHub Configuration (auto-provided)
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_REPO: ${{ github.repository }}
  GITHUB_WORKFLOW_FILE: "thallium_tests.yml"
  
  # Monitor Configuration
  IMAGEN_CUSTOMER_QA_TARGET_COLUMN: ${{ github.event.inputs.target_column || secrets.IMAGEN_CUSTOMER_QA_TARGET_COLUMN }}
  IMAGEN_CUSTOMER_QA_MAX_RETRIES: ${{ secrets.IMAGEN_CUSTOMER_QA_MAX_RETRIES || '3' }}
  IMAGEN_CUSTOMER_QA_THEME_CHANGE_PASSPHRASE: ${{ secrets.IMAGEN_CUSTOMER_QA_THEME_CHANGE_PASSPHRASE }}
  
  # Runtime configuration
  MAX_RUNTIME_SECONDS: 10800  # 3 hours to accommodate proper sequential completion monitoring

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Add metadata to summary
        run: |
          echo "### Thallium ADO Card Movement Monitor" >> $GITHUB_STEP_SUMMARY
          echo "Monitor ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **All configuration and monitoring details are logged by the monitor**" >> $GITHUB_STEP_SUMMARY

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install production monitor dependencies
        run: |
          python -m pip install --upgrade pip
          # Install required packages directly (repository-agnostic)
          pip install requests>=2.31.0 mcp>=1.0.0

      - name: Validate production monitor
        run: |
          echo "Validating production monitor..."
          
          # Check both possible directory structures
          if [ -f "monitor.py" ]; then
            MONITOR_PATH=""
          elif [ -f "CustomerQA/AI_Adoption_POC/azure_devops_monitor.py" ]; then
            MONITOR_PATH="CustomerQA/AI_Adoption_POC"
          else
            echo "ERROR: Production monitor not found"
            exit 1
          fi
          
          echo "âœ… Production monitor found at: $MONITOR_PATH/azure_devops_monitor.py"
          
          # Export the path for use in subsequent steps
          echo "MONITOR_PATH=$MONITOR_PATH" >> $GITHUB_ENV

      - name: Validate configuration
        run: |
          echo "Validating configuration..."
          
          if [ -z "${{ env.IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_PAT }}" ]; then
            echo "ERROR: IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_PAT secret is not configured"
            exit 1
          fi
          
          if [ -z "${{ env.GITHUB_TOKEN }}" ]; then
            echo "ERROR: GITHUB_TOKEN is not available"
            exit 1
          fi
          
          if [ -z "${{ env.IMAGEN_CUSTOMER_QA_TARGET_COLUMN }}" ]; then
            echo "ERROR: IMAGEN_CUSTOMER_QA_TARGET_COLUMN is not configured"
            exit 1
          fi
          
          if [ -z "${{ env.IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_TEAM }}" ]; then
            echo "ERROR: IMAGEN_CUSTOMER_QA_AZURE_DEVOPS_TEAM is not configured"
            exit 1
          fi
          
          echo "Configuration validation passed"

      - name: Run Thallium ADO card movement monitor
        run: |
          echo "ðŸš€ Starting Thallium ADO card movement monitor..."
          cd $MONITOR_PATH
          
          python azure_devops_monitor.py
          
          echo "âœ… Monitor execution completed"

      - name: Upload monitor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ado-card-movement-monitor-logs-${{ github.run_id }}
          path: |
            Customer_QA/AI_Adoption_POC/processed_items.json
            Customer_QA/AI_Adoption_POC/*.log
          retention-days: 14
        if: always()

      - name: Report monitoring results
        if: always()
        run: |
          echo "### ðŸ“Š Monitoring Results" >> $GITHUB_STEP_SUMMARY
          echo "Monitor completed: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Monitor logs contain all detailed results**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check uploaded artifacts for:" >> $GITHUB_STEP_SUMMARY
          echo "  - processed_items.json (state and processed work items)" >> $GITHUB_STEP_SUMMARY
          echo "  - *.log files (detailed execution logs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Monitor Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Automatic branch detection from Azure DevOps work items" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sequential processing with completion monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… State persistence across runs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Team-specific work item filtering" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Enhanced error handling and comprehensive logging" >> $GITHUB_STEP_SUMMARY

